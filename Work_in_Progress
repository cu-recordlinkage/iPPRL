-- Need to add unlinked data density === UID missingness


with uid_groups as (
	select run_id, network_id, uid, count(uid) over (partition by run_id,network_id) as cardinality
	from aim4.network_id )
, linked_uids as (
    select run_id, network_id, uid, cardinality
    from uid_groups
    where cardinality > 1
)
, linked_uids_run as (
    select run_id, network_id, uid, cardinality from linked_uids
    where run_id <= 1
)
, linkage_vars_by_uid as (
	select distinct network_id, ms.uid as uid, mrn, d_source, first_name, last_name,sex, dob,ssn,address, city, state,zip, phone,ssn4
	from linked_uids_run lur join aim4.merged_source ms on lur.uid = ms.uid
	join aim4.year_2011_chd_overall_cummulative c on (ms.id = c.study_id)
)
, linkage_vars_counts_by_nid as (
	select network_id
		, count(first_name) as fn_linkage_count
		, count(last_name) as ln_linkage_count
		, count(sex) as sex_linkage_count
		, count(dob) as dob_linkage_count
		, count(ssn) as ssn_linkage_count
		, count(address) as address_linkage_count
		, count(city) as city_linkage_count
		, count(state) as state_linkage_count
		, count(zip) as zip_linkage_count
		, count(phone) as phone_linkage_count
		, count(ssn4) as ssn4_linkage_count
	from linkage_vars_by_uid
	group by network_id
)
, linked_data_density as (
select 'Linked' as type
	, round(avg(fn_linkage_count),2) as fn_data_density
    , round(avg(ln_linkage_count),2) as ln_data_density
	, round(avg(sex_linkage_count),2) as sex_data_density
	, round(avg(dob_linkage_count),2) as dob_data_density
	, round(avg(ssn_linkage_count),2) as ssn_data_density
	, round(avg(address_linkage_count),2) as address_data_density
	, round(avg(city_linkage_count),2) as city_data_density
	, round(avg(state_linkage_count),2) as state_data_density
	, round(avg(zip_linkage_count),2) as zip_data_density
	, round(avg(phone_linkage_count),2) as phone_data_density
	, round(avg(ssn4_linkage_count),2) as ssn4_data_density
from linkage_vars_counts_by_nid 
)
, unlinked_data_density as ( -- same as missingness
	select 'Unlinked'
	,